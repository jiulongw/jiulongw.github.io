<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>How to Embed Unity Project into iOS Swift Project | Born to Learn</title>
<link rel="stylesheet" href="https://jiulongw.github.io/css/style.css" />
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/github.min.css" />


<link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">

</head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://jiulongw.github.io"><h1 class="title is-4">Born to Learn</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/jiulongw">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/jiulongw">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/unity">#Unity</a>



  
  | <a class="subtitle is-6" href="/tags/ios">#iOS</a>
  
  | <a class="subtitle is-6" href="/tags/swift">#Swift</a>
  


      
    </div>
    <h2 class="subtitle is-6">September 27, 2017</h2>
    <h1 class="title">How to Embed Unity Project into iOS Swift Project</h1>
    <div class="content">
      <p>A demo project that embeds Unity 2017.1 project into iOS Xcode 9 project.</p>

<p></p>

<p><a href="https://github.com/jiulongw/swift-unity">This repo</a> contains a demo Xcode 9 iOS project (Swift 4.0) that builds a single view app with an embeded Unity3d
scene (Unity 2017.1.1f1).  The idea here is to automate build processes for both projects as much as possible to avoid
manual copy &amp; paste every time Unity project is updated.  It also demonstrates runtime communication between Swift
and Unity.</p>

<p>This would not be possible without <a href="https://github.com/blitzagency/ios-unity5">tutorial by BLITZ</a> and <a href="http://www.the-nerd.be/2015/08/20/a-better-way-to-integrate-unity3d-within-a-native-ios-application/">video by the-nerd Frederik Jacques</a>.  Minor updates
are applied to fit latest Xcode and Unity releases.  Here I will briefly go through the process and highlight
these updates.</p>

<h2 id="unity-project">Unity Project</h2>

<p>A post build process script is added to Unity project. After each build, Xcode project gets information about
where Unity dropped build outputs.  This way we don&rsquo;t have to use same build drop every time.</p>

<pre><code class="language-cs">[PostProcessBuild]
public static void OnPostBuild(BuildTarget target, string pathToBuiltProject)
{
#if UNITY_IOS
    var config = new StringBuilder();
    config.AppendFormat(&quot;UNITY_RUNTIME_VERSION = {0};&quot;, Application.unityVersion);
    config.AppendLine();
    config.AppendFormat(&quot;UNITY_IOS_EXPORT_PATH = {0};&quot;, pathToBuiltProject);
    config.AppendLine();

    var configPath = Path.Combine(Environment.CurrentDirectory, &quot;../xcode/DemoApp/Unity/Exports.xcconfig&quot;);
    File.WriteAllText(configPath, config.ToString());
#endif
}
</code></pre>

<p>This requires the Unity project to know the location of the Xcode project.  Typically it is a sibling folder in the
same workspace.</p>

<h2 id="xcode-project">Xcode Project</h2>

<p>In a nutshell, to embed Unity project into Swift project, we need to:</p>

<ol>
<li>Include Unity generated code in <code>Classes</code> and <code>Libraries</code> folders in Xcode build target.</li>
<li>Remove <code>main</code> entry point and pass events from <code>AppDelegate</code> to <code>UnityAppController</code>.</li>
<li>Get Unity GL view and add it as subview to the desired <code>UIViewController</code>.</li>
<li>Copy <code>Data</code> folder to <code>Product.app</code> after build.</li>
</ol>

<h3 id="add-code-to-build-target">Add Code to Build Target</h3>

<p>The <code>Classes</code> and <code>Libraries</code> folders need to be compiled into the Xcode project&rsquo;s build target. We&rsquo;re going to make
changes to some of the generated files.  As a result, as part of the build process, we copy these two folders and
exclude those unchanged files from source control.</p>

<p>Here is a list of files that needs to be modified.</p>

<ul>
<li>Classes/Unity/MetalHelper.mm</li>
</ul>

<p>Add <code>MTLTextureUsageRenderTarget</code> to the stencil texture descriptor to fix runtime assertion failure.  Not sure if
  this is a bug in Xcode or Unity but following line fixed the issue.</p>

<pre><code class="language-objc">  stencilTexDesc.usage |= MTLTextureUsageRenderTarget;
</code></pre>

<ul>
<li>Classes/UnityAppController.h</li>
</ul>

<p>Because we modified how UnityAppController is created, we need to change the code that retrieves it.</p>

<pre><code class="language-objc">  //inline UnityAppController* GetAppController()
  //{
  //    return (UnityAppController*)[UIApplication sharedApplication].delegate;
  //}

  NS_INLINE UnityAppController* GetAppController()
  {
      NSObject&lt;UIApplicationDelegate&gt;* delegate = [UIApplication sharedApplication].delegate;
      UnityAppController* currentUnityController = (UnityAppController *)[delegate valueForKey:@&quot;currentUnityController&quot;];
      return currentUnityController;
  }
</code></pre>

<ul>
<li>Classes/UnityAppController.mm</li>
</ul>

<p>Initializing Unity view is asynchronous.  Before it is done we cannot add it to our UIViewController.  To solve this,
  we issue a notification when Unity view is fully loaded and in our UIViewController, handle the notification and add
  view accordingly.</p>

<pre><code class="language-objc">  [[NSNotificationCenter defaultCenter] postNotificationName:@&quot;UnityReady&quot; object:self];
</code></pre>

<ul>
<li>Classes/main.mm</li>
</ul>

<p>Here we simply rename <code>main</code> so that it won&rsquo;t conflict with Swift&rsquo;s <code>main</code> entry.</p>

<p>These files are added to source control and skipped by script that copies updates from Unity build.</p>

<h3 id="setup-unityappcontroller">Setup UnityAppController</h3>

<p>Since we renamed <code>main</code> entry in main.mm, UntiyAppController needs to be setup properly to handle app events.
Sample code can be found in <a href="https://github.com/jiulongw/swift-unity/blob/master/demo/xcode/DemoApp/AppDelegate.swift">AppDelegate.swift</a>.</p>

<p>Note in order to call Objective-C method from Swift code, a <a href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/BuildingCocoaApps/MixandMatch.html">bridging header file</a> needs to be configured in Xcode.</p>

<h3 id="embed-unity-view">Embed Unity View</h3>

<p>Once everything is in place, embedding the Unity view is pretty straightforward.</p>

<pre><code class="language-swift">class ViewController: UIViewController {
    override func viewDidLoad() {
        super.viewDidLoad()
        if let appDelegate = UIApplication.shared.delegate as? AppDelegate {
            appDelegate.startUnity()
            NotificationCenter.default.addObserver(
                self,
                selector: #selector(handleUnityReady),
                name: NSNotification.Name(&quot;UnityReady&quot;),
                object: nil)
        }
    }

    @objc func handleUnityReady() {
        if let unityView = UnityGetGLView() {
            // insert subview at index 0 ensures unity view is behind current UI view
            view?.insertSubview(unityView, at: 0)
        }
    }
}
</code></pre>

<h3 id="build-scripts-to-sync-unity-outputs">Build Scripts to Sync Unity Outputs</h3>

<p>During prebuild, update code generated by Unity.</p>

<pre><code class="language-sh">echo &quot;Syncing code from $UNITY_IOS_EXPORT_PATH...&quot;
rsync -rc --exclude-from=DemoApp/Unity/rsync_exclude --delete $UNITY_IOS_EXPORT_PATH/Classes/ DemoApp/Unity/Classes/
rsync -rc --exclude-from=DemoApp/Unity/rsync_exclude --delete $UNITY_IOS_EXPORT_PATH/Libraries/ DemoApp/Unity/Libraries/
</code></pre>

<p>During post build, copy <code>Data</code> folder that contains runtime resources.</p>

<pre><code class="language-sh">echo &quot;Syncing data from $UNITY_IOS_EXPORT_PATH...&quot;
rm -rf &quot;$TARGET_BUILD_DIR/$PRODUCT_NAME.app/Data&quot;
cp -Rf &quot;$UNITY_IOS_EXPORT_PATH/Data&quot; &quot;$TARGET_BUILD_DIR/$PRODUCT_NAME.app/Data&quot;
</code></pre>

<h2 id="known-issues">Known Issues</h2>

<p>The Xcode project file can be out of sync if you add new plugins to the Unity project.  This is because Xcode explicitly
list source code files that are added to build target, instead of scanning whole directory for updates.  This can be
solved by manually add files to Xcode after build (prebuild script will copy all files), or write another post build
script on Unity side to programmatically add files to Xcode build target.</p>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'jiulongw';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://jiulongw.github.io">jiulongw</a> 2016</p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-86115491-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



</body>
</html>

